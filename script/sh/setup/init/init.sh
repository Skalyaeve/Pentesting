#!/bin/bash
#=======================#
# Init my shell session #
#=======================#

STOP="\\e[0m"
GREEN="\\e[32m"
GRAY="\\e[90m"

if [ $# -lt 1 ]
then
    echo "usage: $0 <user> [--all|--git|--wget|--apt]"
    exit 1
fi

USER="$1"
if [ "$USER" = "root" ]
then
    HOME=/root
else
    HOME=/home/$USER
fi
ROOT=$HOME/script/sh/setup/init
RESOURCES=$ROOT/resources
BACKDIR=$ROOT/backup
A_FILE=(
    .zshrc
    .nanorc
)
#A_REPO=(
#)
A_TOOL=(
    /usr/local/bin/linpeas.sh
    https://github.com/carlospolop/PEASS-ng/releases/download/20231224-836b4ac9/linpeas.sh
)
DO_GIT=0
DO_APT=0
DO_WGET=0
THEME="black"

for arg in "$@"
do
    case "$arg" in
        "--all") DO_GIT=1; DO_APT=1; DO_WGET=1 ;;
        "--git") DO_GIT=1 ;;
        "--apt") DO_APT=1 ;;
        "--wget") DO_WGET=1 ;;
    esac
done
echo -e "$GRAY[$GREEN READY $GRAY]$STOP"

echo -e "$GRAY================ CONFIG$STOP"
if [ ! -d $BACKDIR ]
then
    echo "Creating $BACKDIR"
    mkdir $BACKDIR
    chown $USER $BACKDIR
fi
for file in ${A_FILE[@]}
do
    if [ $file != ${A_FILE[0]} ]
    then
        echo
    fi
    src=$RESOURCES/config/$file
    dst=$HOME/$file
    bak=$BACKDIR/$file.bak
    if [ -f $dst ]
    then
        if [ ! -f $bak ]
        then
            echo "Backing up $dst to $bak"
            cp $dst $bak
            chown $USER $bak
        fi
        echo "Removing $dst"
        rm $dst
    fi
    echo "Linking $src to $dst"
    ln -s $src $dst
    chown $USER $dst
done
echo -e "$GRAY================ CONFIG [$GREEN OK $GRAY]$STOP"

#if [ $DO_GIT -eq 1 ]
#then
#    echo -e "\n$GRAY================ GIT CLONE$STOP"
#    for ((index = 0; index < ${#A_REPO[@]}; index += 2))
#    do
#        if [ $index -ne 0 ]
#        then
#            echo
#        fi
#        dst=${A_REPO[$index]}
#        url=${A_REPO[$(($index + 1))]}
#        if [ ! -d "$dst" ]
#        then
#            echo "Cloning $url into $dst"
#            git clone $url $dst
#        fi
#    done
#    chown -R $USER $dst
#    echo -e "$GRAY================ GIT CLONE [$GREEN OK $GRAY]$STOP"
#fi

if [ $DO_WGET -eq 1 ]
then
    echo -e "\n$GRAY================ WGET DOWNLOAD$STOP"
    for ((index = 0; index < ${#A_TOOL[@]}; index += 2))
    do
        if [ $index -ne 0 ]
        then
            echo
        fi
        dst=${A_TOOL[$index]}
        url=${A_TOOL[$(($index + 1))]}
        if [ ! -d "$dst" ]
        then
            echo "Downloading $url into $dst"
            wget -q $url -O $dst
        fi
    done
    chown -R $USER $dst
    echo -e "$GRAY================ WGET DOWNLOAD [$GREEN OK $GRAY]$STOP"
fi

if [ $DO_APT -eq 1 ]
then
    echo -e "\n$GRAY================ APT INSTALL$STOP"
    tools=$(cat "$RESOURCES/list/tools.list" | grep -v "#" | tr "\n" " ")

    echo "Installing: $tools"
    echo -e "$GRAY================ >>$STOP"
    apt update && apt install -y $tools
    echo -e "$GRAY================ APT INSTALL [$GREEN OK $GRAY]$STOP"
fi
echo -e "$GRAY[$GREEN DONE $GRAY]$STOP"
