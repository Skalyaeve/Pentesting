#!/bin/bash
ceil_log2() {
    n=$1
    if (( n <= 1 )); then
        echo 0
    else
        echo "$((1 + $(ceil_log2 $((n / 2)))))"
    fi
}

split_network() {
    address=$1
    div=$2

    mask=$(echo $address | cut -d'/' -f2)
    mod=$(ceil_log2 $div)
    mask=$((mask + mod))
    if (( mask > 32 )); then
        echo "Cannot split network into $div subnets"
        exit 2
    fi

    subnet_count=$((2**mod))
    IFS=. read -r i1 i2 i3 i4 <<< "$(echo $address | cut -d'/' -f1)"
    for (( i = 0; i < subnet_count; i++ )); do
        dec="$((i4 + i*(2**(32-mask))))"
        new_ip="$i1.$i2.$i3.$dec"
        echo "────────────Sub-Network $new_ip/$mask"
        ipcalc $new_ip/$mask
    done
}

command -v ipcalc >/dev/null 2>&1 || { echo >&2 "ipcalc not installed"; exit 1; }
if [ $# -lt 1 ]; then
    echo "Usage: $0 address [--div nombre_de_sous_reseaux]"
    exit 1
fi

address=$1
echo "────Network $address"
ipcalc $address
if [[ $2 == "--div" ]] && [ $# -eq 3 ]; then
    split_network $address $3
fi
