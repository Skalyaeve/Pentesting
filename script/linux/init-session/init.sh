#!/bin/bash
if [ $# -lt 1 ]
then
    echo "Usage: $0 <user> [--all|--git|--apt]"
    exit 1
fi

USER="$1"
if [ "$USER" = "root" ]
then
    HOME=/root
else
    HOME=/home/$USER
fi
ROOT=$HOME/script/linux/init-session
RESOURCES=$ROOT/resources
BACKDIR=$ROOT/backup
A_FILE=(
    .zshrc
    .nanorc
)
A_REPO=(
    peass
    https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite.git
)
DO_GIT=0
DO_APT=0
THEME="black"

for arg in "$@"
do
    if [ "$arg" = --all ]
    then
        DO_GIT=1
        DO_APT=1

    elif [ "$arg" = --git ]
    then
        DO_GIT=1

    elif [ "$arg" = --apt ]
    then
        DO_APT=1
    fi
done
source $RESOURCES/color/$THEME.sh
echo -e "$GRAY[$GREEN READY $GRAY]$STOP"

echo -e "$GRAY================ CONFIG$STOP"
if [ ! -d $BACKDIR ]
then
    echo "Creating $BACKDIR"
    mkdir $BACKDIR
    chown $USER $BACKDIR
fi
for file in ${A_FILE[@]}
do
    if [ $file != ${A_FILE[0]} ]
    then
        echo
    fi
    src=$RESOURCES/config/$file
    dst=$HOME/$file
    bak=$BACKDIR/$file.bak
    if [ -f $dst ]
    then
        if [ ! -f $bak ]
        then
            echo "Backing up $dst to $bak"
            cp $dst $bak
            chown $USER $bak
        fi
        echo "Removing $dst"
        rm $dst
    fi
    echo "Linking $src to $dst"
    ln -s $src $dst
    chown $USER $dst
done
echo -e "$GRAY================ CONFIG [$GREEN OK $GRAY]$STOP"

if [ $DO_GIT -eq 1 ]
then
    echo -e "\n$GRAY================ GIT CLONE$STOP"
    dir=$HOME/tools
    if [ ! -d $dir ]
    then
        echo "Creating $dir"
        mkdir $dir
    fi
    for ((index = 0; index < ${#A_REPO[@]}; index += 2))
    do
        if [ $index -ne 0 ]
        then
            echo
        fi
        name=${A_REPO[$index]}
        url=${A_REPO[$(($index + 1))]}
        if [ ! -d "$dir/$name" ]
        then
            echo "Cloning $url into $dir/$name"
            git clone $url $dir/$name
        fi
    done
    chown -R $USER $dir
    echo -e "$GRAY================ GIT CLONE [$GREEN OK $GRAY]$STOP"
fi

if [ $DO_APT -eq 1 ]
then
    echo -e "\n$GRAY================ APT INSTALL$STOP"
    tools=$(cat "$RESOURCES/list/tools.list" | tr "\n" " ")

    echo "Installing: $tools"
    echo -e "$GRAY================ >>$STOP"
    apt update && apt install -y $tools
    echo -e "$GRAY================ APT INSTALL [$GREEN OK $GRAY]$STOP"
fi
echo -e "$GRAY[$GREEN DONE $GRAY]$STOP"
